{% extends 'invoices/base.html' %} {% block content %}
<style>
  .form-section-title {
    font-size: 1.1rem;
    color: var(--accent-color);
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid var(--sidebar-border);
    font-weight: 600;
  }
  .form-card {
    background-color: var(--card-bg);
    border: 1px solid var(--sidebar-border);
    transition: var(--transition);
  }
  .form-control {
    background-color: var(--card-bg) !important;
    color: var(--text-main) !important;
    border-color: var(--input-border) !important;
    padding: 0.75rem 1rem;
    border-radius: 0.75rem;
  }
  .form-control:focus {
    border-color: var(--accent-color) !important;
    box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
  }
  .btn-submit {
    background: linear-gradient(135deg, var(--accent-color) 0%, #4338ca 100%);
    border: none;
    padding: 0.8rem 2rem;
    font-weight: 600;
    border-radius: 0.75rem;
    transition: var(--transition);
  }
  .btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
    opacity: 0.9;
  }
  .input-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-main);
    margin-bottom: 0.5rem;
    display: block;
  }
  .bg-light-themed {
    background-color: var(--nav-link-hover-bg) !important;
  }
</style>

<div class="row justify-content-center">
  <div class="col-12 col-xl-11">
    <div class="card form-card shadow-sm border-0 rounded-4">
      <div class="card-body p-2 p-md-4">
        <div class="text-center mb-2">
          <h3 class="fw-bold mb-1" style="color: var(--text-main)">
            {{ title|default:"Create New Quotation" }}
          </h3>
          <p class="text-muted">
            Fill in the details below to generate a professional quotation.
          </p>
        </div>

        <form method="post">
          {% csrf_token %}

          <!-- Section 1: Client Information -->
          <div class="row mb-2">
            <div class="col-12">
              <h5 class="form-section-title">
                <i class="bi bi-person-badge"></i> Client Information
              </h5>
            </div>
            <div class="col-md-4 mb-3">
              <label class="input-label">Client / Company Name</label>
              {{ form.client_name }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="input-label">Mobile Number</label>
              {{ form.mobile_number }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="input-label">Billing Address</label>
              {{ form.address }}
            </div>
          </div>

          <!-- Section 2: Project & Financial Details -->
          <div class="row mb-2">
            <div class="col-12">
              <h5 class="form-section-title">
                <i class="bi bi-file-earmark-text"></i> Quotation Details
              </h5>
            </div>
            <div class="col-12 mb-3">
              <label class="input-label">Subject / Project Title</label>
              {{ form.subject }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="input-label">Reference Number</label>
              {{ form.reference_no }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="input-label">Date of Issue</label>
              {{ form.date }}
            </div>
            <div class="col-md-4 mb-3">
              <label class="input-label">Total Amount (AED)</label>
              <div class="input-group">
                <span class="input-group-text bg-light border-end-0">AED</span>
                {{ form.amount }}
              </div>
              <!-- Live Calculation Summary -->
              <div
                class="mt-3 p-3 bg-light-themed rounded-3 border"
                style="border-color: var(--sidebar-border) !important"
              >
                <div
                  class="d-flex justify-content-between mb-1"
                  style="font-size: 0.9rem"
                >
                  <span class="text-muted">Sub Total:</span>
                  <span
                    class="fw-bold text-dark"
                    style="color: var(--text-main) !important"
                    >AED <span id="summary-subtotal">0.00</span></span
                  >
                </div>
                <div
                  class="d-flex justify-content-between mb-1"
                  style="font-size: 0.9rem"
                >
                  <span class="text-muted">VAT (5%):</span>
                  <span class="text-danger fw-bold"
                    >AED <span id="summary-vat">0.00</span></span
                  >
                </div>
                <div
                  class="d-flex justify-content-between pt-2 border-top mt-2"
                  style="border-color: var(--sidebar-border) !important"
                >
                  <span
                    class="fw-bold text-dark"
                    style="color: var(--text-main) !important"
                    >Grand Total:</span
                  >
                  <span
                    class="fw-bold text-primary"
                    style="color: var(--accent-color) !important"
                    >AED <span id="summary-total">0.00</span></span
                  >
                </div>
              </div>
            </div>
          </div>

          <!-- Section 3: Scope of Work -->
          <div class="row mb-2">
            <div class="col-12">
              <h5 class="form-section-title">
                <i class="bi bi-list-check"></i> Work Description
              </h5>
            </div>
            <div class="col-12">
              <label class="input-label">Detailed Scope of Work / Terms</label>
              {{ form.work_description }}
              <div class="form-text mt-1 text-muted">
                Provide a clear description of the services or products
                provided.
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-3 mt-3">
            <a
              href="{% url 'invoice_list' %}"
              class="btn btn-light px-4 py-2 fw-semibold"
              >Cancel</a
            >
            <button type="submit" class="btn btn-primary btn-submit px-5 py-2">
              <i class="bi bi-check-circle me-2"></i>Save & Generate Quotation
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Success Modal -->
{% if created_invoice %}
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg rounded-4">
      <div
        class="modal-header bg-success border-0 text-white p-4 rounded-top-4"
      >
        <h5 class="modal-title fw-bold">
          <i class="bi bi-check-circle-fill me-2"></i> Success
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body text-center p-5">
        <div class="mb-4">
          <div class="display-4 text-success">
            <i class="bi bi-check2-circle"></i>
          </div>
        </div>
        <h4 class="fw-bold" style="color: var(--text-main) !important">
          Quotation Ready!
        </h4>
        <p class="text-muted mb-4">
          The quotation for
          <strong>{{ created_invoice.client_name }}</strong> has been saved
          successfully.
        </p>

        <div class="d-grid gap-2">
          <a
            href="{% url 'generate_quotation' created_invoice.id %}"
            class="btn btn-primary py-2 fw-bold"
            target="_blank"
          >
            <i class="bi bi-file-earmark-pdf me-2"></i>Download Quotation PDF
          </a>
          <a
            href="{% url 'generate_pdf' created_invoice.id %}"
            class="btn btn-outline-primary py-2 fw-bold"
            target="_blank"
          >
            <i class="bi bi-file-earmark-text me-2"></i>Download Invoice PDF
          </a>
          <div class="border-top my-3"></div>
          <button
            type="button"
            class="btn btn-link text-muted text-decoration-none"
            data-bs-dismiss="modal"
          >
            Close & Create Another
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", function() {
      // Dynamic Form Control Enhancement
      var inputs = document.querySelectorAll('input:not([type="checkbox"]):not([type="radio"]), select, textarea');
      inputs.forEach(function(input) {
          if (!input.classList.contains('input-group')) {
            input.classList.add('form-control');
          }
      });

      // Special handling for textareas
      var textareas = document.querySelectorAll('textarea');
      textareas.forEach(function(textarea) {
          textarea.rows = 2;
          textarea.placeholder = "Enter detailed description here...";
      });

      // Show Success Modal
      {% if created_invoice %}
          var successModal = new bootstrap.Modal(document.getElementById('successModal'));
          successModal.show();
      {% endif %}

      // Live Calculation Logic
      const amountInput = document.getElementById('id_amount');
      const subTotalDisplay = document.getElementById('summary-subtotal');
      const vatDisplay = document.getElementById('summary-vat');
      const totalDisplay = document.getElementById('summary-total');

      if (amountInput) {
          function updateCalculations() {
              const amount = parseFloat(amountInput.value) || 0;
              const vat = amount * 0.05;
              const total = amount + vat;

              subTotalDisplay.textContent = amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
              vatDisplay.textContent = vat.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
              totalDisplay.textContent = total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          }

          amountInput.addEventListener('input', updateCalculations);
          // Initial calculation in case of edit or browser refresh
          updateCalculations();
      }
  });
</script>
{% endblock %}

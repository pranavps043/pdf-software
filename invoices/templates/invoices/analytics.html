{% extends 'invoices/base.html' %} {% block content %}
<div class="container-fluid py-2">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="fw-bold mb-1" style="color: var(--text-main)">
        Business Analytics
      </h3>
      <p class="text-muted mb-0">Insights and performance overview</p>
    </div>
    <div class="d-flex gap-2">
      <a
        id="exportBtn"
        href="{% url 'export_analytics_csv' %}?period={{ period }}&date_from={{ date_from }}&date_to={{ date_to }}"
        class="btn btn-light border-0 rounded-3"
        style="background-color: var(--card-bg); color: var(--text-main)"
      >
        <i class="bi bi-download me-2"></i>Export Report
      </a>
      <a
        href="{% url 'invoice_create' %}"
        class="btn btn-primary rounded-3 px-4"
      >
        <i class="bi bi-plus-lg me-2"></i>New Quotation
      </a>
    </div>
  </div>

  <!-- Filters -->
  <div
    class="card border-0 shadow-sm rounded-4 mb-4"
    style="background-color: var(--card-bg)"
  >
    <div class="card-body p-3">
      <form
        method="get"
        id="analyticsFilterForm"
        class="row g-3 align-items-end"
      >
        <div class="col-md-3">
          <label class="small fw-semibold text-muted mb-2 d-block"
            >Quick Filter</label
          >
          <select
            name="period"
            id="periodSelect"
            class="form-select border-0 bg-light-themed rounded-3"
            style="background-color: var(--nav-link-hover-bg) !important"
          >
            <option
              value="custom"
              {%
              if
              period=""
              ="custom"
              %}selected{%
              endif
              %}
            >
              Custom Range
            </option>
            <option
              value="this_month"
              {%
              if
              period=""
              ="this_month"
              %}selected{%
              endif
              %}
            >
              This Month
            </option>
            <option
              value="last_month"
              {%
              if
              period=""
              ="last_month"
              %}selected{%
              endif
              %}
            >
              Last Month
            </option>
            <option
              value="last_6_months"
              {%
              if
              period=""
              ="last_6_months"
              %}selected{%
              endif
              %}
            >
              Last 6 Months
            </option>
            <option
              value="this_year"
              {%
              if
              period=""
              ="this_year"
              %}selected{%
              endif
              %}
            >
              This Year
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="small fw-semibold text-muted mb-2 d-block"
            >From Date</label
          >
          <input
            type="date"
            name="date_from"
            id="dateFrom"
            value="{{ date_from }}"
            {%
            if
            period
            !="custom"
            %}readonly{%
            endif
            %}
            class="form-control border-0 bg-light-themed rounded-3"
            style="background-color: var(--nav-link-hover-bg) !important"
          />
        </div>
        <div class="col-md-3">
          <label class="small fw-semibold text-muted mb-2 d-block"
            >To Date</label
          >
          <input
            type="date"
            name="date_to"
            id="dateTo"
            value="{{ date_to }}"
            {%
            if
            period
            !="custom"
            %}readonly{%
            endif
            %}
            class="form-control border-0 bg-light-themed rounded-3"
            style="background-color: var(--nav-link-hover-bg) !important"
          />
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button type="submit" class="btn btn-primary flex-grow-1 rounded-3">
            <i class="bi bi-filter me-2"></i>Apply
          </button>
          <a
            href="{% url 'analytics' %}"
            class="btn btn-light border-0 rounded-3"
            style="
              background-color: var(--nav-link-hover-bg);
              color: var(--text-main);
            "
          >
            <i class="bi bi-arrow-counterclockwise"></i>
          </a>
        </div>
      </form>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="row g-3 mb-4">
    <div class="col-md-3">
      <div
        class="card border-0 shadow-sm rounded-4"
        style="background-color: var(--card-bg)"
      >
        <div class="card-body p-4">
          <div
            class="small text-muted mb-1 text-uppercase fw-semibold"
            style="letter-spacing: 0.5px"
          >
            Total Revenue
          </div>
          <h2 class="fw-bold mb-0" style="color: var(--text-main)">
            AED {{ total_revenue|floatformat:2 }}
          </h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div
        class="card border-0 shadow-sm rounded-4"
        style="background-color: var(--card-bg)"
      >
        <div class="card-body p-4">
          <div
            class="small text-muted mb-1 text-uppercase fw-semibold"
            style="letter-spacing: 0.5px"
          >
            VAT Collected (5%)
          </div>
          <h2 class="fw-bold mb-0" style="color: #10b981">
            AED {{ total_vat|floatformat:2 }}
          </h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div
        class="card border-0 shadow-sm rounded-4"
        style="background-color: var(--card-bg)"
      >
        <div class="card-body p-4">
          <div
            class="small text-muted mb-1 text-uppercase fw-semibold"
            style="letter-spacing: 0.5px"
          >
            Total Quotations
          </div>
          <h2 class="fw-bold mb-0" style="color: var(--accent-color)">
            {{ total_count }}
          </h2>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div
        class="card border-0 shadow-sm rounded-4"
        style="background-color: var(--card-bg)"
      >
        <div class="card-body p-4">
          <div
            class="small text-muted mb-1 text-uppercase fw-semibold"
            style="letter-spacing: 0.5px"
          >
            Avg. Value
          </div>
          <h2 class="fw-bold mb-0" style="color: #f59e0b">
            AED {{ avg_value|floatformat:0 }}
          </h2>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <!-- Revenue Chart -->
    <div class="col-lg-8">
      <div
        class="card border-0 shadow-sm rounded-4 h-100"
        style="background-color: var(--card-bg)"
      >
        <div class="card-header bg-transparent border-0 p-4 pb-0">
          <h5 class="fw-bold mb-0" style="color: var(--text-main)">
            Revenue Growth
          </h5>
          <p class="text-muted small">Last 6 months performance</p>
        </div>
        <div class="card-body p-4">
          <canvas id="revenueChart" style="max-height: 300px"></canvas>
        </div>
      </div>
    </div>

    <!-- Top Clients -->
    <div class="col-lg-4">
      <div
        class="card border-0 shadow-sm rounded-4 h-100"
        style="background-color: var(--card-bg)"
      >
        <div class="card-header bg-transparent border-0 p-4 pb-0">
          <h5 class="fw-bold mb-0" style="color: var(--text-main)">
            Top Clients
          </h5>
          <p class="text-muted small">By total revenue contribution</p>
        </div>
        <div class="card-body p-4">
          <div class="d-flex flex-column gap-3">
            {% for client in top_clients %}
            <div
              class="d-flex align-items-center justify-content-between p-3 rounded-4"
              style="background-color: var(--nav-link-hover-bg)"
            >
              <div class="d-flex align-items-center gap-3">
                <div
                  class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center"
                  style="width: 40px; height: 40px; font-weight: 600"
                >
                  {{ client.client_name|first|upper }}
                </div>
                <div>
                  <div
                    class="fw-bold small text-truncate"
                    style="max-width: 120px; color: var(--text-main)"
                  >
                    {{ client.client_name }}
                  </div>
                  <div class="text-muted" style="font-size: 0.75rem">
                    {{ client.count }} items
                  </div>
                </div>
              </div>
              <div class="fw-bold" style="color: var(--accent-color)">
                AED {{ client.total|floatformat:0 }}
              </div>
            </div>
            {% empty %}
            <p class="text-center text-muted py-5">No client data available</p>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const revenueData = {{ revenue_data|safe }};
    const labels = revenueData.map(d => d.month);
    const data = revenueData.map(d => d.revenue);

    const ctx = document.getElementById('revenueChart').getContext('2d');

    // Theme Variables
    const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
    const accentColor = '#4f46e5';
    const textColor = isDark ? '#94a3b8' : '#64748b';
    const gridColor = isDark ? 'rgba(148, 163, 184, 0.05)' : 'rgba(100, 116, 139, 0.05)';

    // Gradient generation
    const gradient = ctx.createLinearGradient(0, 0, 0, 300);
    gradient.addColorStop(0, 'rgba(79, 70, 229, 0.15)');
    gradient.addColorStop(1, 'rgba(79, 70, 229, 0)');

    // Plugin for line glow
    const shadowPlugin = {
      id: 'shadowPlugin',
      beforeDraw: (chart) => {
        const { ctx } = chart;
        ctx.save();
        ctx.shadowColor = 'rgba(79, 70, 229, 0.3)';
        ctx.shadowBlur = 15;
        ctx.shadowOffsetX = 0;
        ctx.shadowOffsetY = 10;
      },
      afterDraw: (chart) => {
        chart.ctx.restore();
      }
    };

    new Chart(ctx, {
      type: 'line',
      plugins: [shadowPlugin],
      data: {
        labels: labels,
        datasets: [{
          label: 'Revenue',
          data: data,
          borderColor: accentColor,
          borderWidth: 4,
          backgroundColor: gradient,
          fill: true,
          tension: 0.4,
          pointRadius: 0, // Hidden by default for cleaner look
          pointHoverRadius: 6,
          pointHoverBackgroundColor: accentColor,
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 3,
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
          duration: 2000,
          easing: 'easeOutQuart'
        },
        interaction: {
          intersect: false,
          mode: 'index',
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            backgroundColor: isDark ? 'rgba(15, 23, 42, 0.8)' : 'rgba(255, 255, 255, 0.8)',
            backdropFilter: 'blur(8px)',
            titleColor: isDark ? '#f8fafc' : '#1e293b',
            titleFont: { size: 13, weight: '700' },
            bodyColor: isDark ? '#94a3b8' : '#64748b',
            bodyFont: { size: 12 },
            padding: 15,
            borderColor: isDark ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)',
            borderWidth: 1,
            cornerRadius: 16,
            displayColors: false,
            callbacks: {
              label: function(context) {
                return 'AED ' + context.parsed.y.toLocaleString();
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            border: { display: false },
            grid: {
              color: gridColor,
              drawTicks: false,
            },
            ticks: {
              color: textColor,
              padding: 15,
              font: { size: 11, weight: '500' },
              callback: (value) => 'AED ' + (value >= 1000 ? value / 1000 + 'k' : value)
            }
          },
          x: {
            border: { display: false },
            grid: { display: false },
            ticks: {
              color: textColor,
              padding: 10,
              font: { size: 11, weight: '500' }
            }
          }
        }
      }
    });

    // Theme Switch Listener
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.attributeName === 'data-bs-theme') {
          location.reload();
        }
      });
    });
    observer.observe(document.documentElement, { attributes: true });

    // Period Auto-submit
    document.getElementById('periodSelect').addEventListener('change', function() {
      if (this.value !== 'custom') {
        document.getElementById('analyticsFilterForm').submit();
      } else {
        document.getElementById('dateFrom').readOnly = false;
        document.getElementById('dateTo').readOnly = false;
      }
    });
  });
</script>
{% endblock %}
